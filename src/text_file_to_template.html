<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <link href="/favicon.png" rel="icon" type="image/png"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="theme-color" content="#ce0000">
    <meta name="title" content="Red DF | Text File to Template">
    <meta name="description" content="Convert a text file separated by newlines to a template containing a list">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="./style.css" rel="stylesheet">
    <title>Red DF | Text File to Template</title>
</head>
<body class="bg-gray-950 text-white">
<nav class="bg-gray-800">
    <div class="max-w-7xl px-2 sm:px-6 lg:px-8">
        <div class="relative flex h-16 items-center justify-between">
            <div class="flex flex-1 items-stretch justify-start">
                <div class="ml-6">
                    <div class="flex space-x-4">
                        <a class="nav-item" href="/">Home</a>
                        <a class="nav-item" href="/color_palette">Color Palette</a>
                        <a href="#" class="nav-item">Template Splitter</a>
                        <a href="#" class="nav-item nav-selected-item">Text File to Template</a>
                        <a href="#" class="nav-item">Skin Pixel Art Generator</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>

<main>
    <header>
        <h1>Text File to Template</h1>
        <h2>Convert a text file separated by newlines to a list</h2>
    </header>

    <h2>Pick a file!</h2>
    <p id="resultText"></p>
    <label class="file-upload">
        <input type="file">
        Browse...
    </label>

    <h2>Options</h2>
    <div class="grid grid-cols-4 grid-rows-2 gap-1.5">
        <label for="functionName">Function Name</label>
        <label for="variableName">Variable Name</label>
        <label for="useParameter">Use Parameter (overrides Variable Scope)</label>
        <label for="variableScope">Variable Scope</label>

        <input autocomplete="off" id="functionName" type="text" value="text">
        <input autocomplete="off" id="variableName" type="text" value="output">
        <input autocomplete="off" checked id="useParameter" type="checkbox">
        <select autocomplete="off" id="variableScope">
            <option value="unsaved">Global</option>
            <option value="saved">Saved</option>
            <option selected="selected" value="line">Line</option>
            <option value="local">Local</option>
        </select>
    </div>

    <br>
    <p>
        After selecting a file, it will be processed and sent to you in-game. <b>If you are a CodeClient user run /auth
        right now!</b>
        <br>
        All files are processed locally, and nothing is uploaded anywhere (except for the template to recode/codeclient)
    </p>

</main>

<script src="./main.js" type="module"></script>
<script type="module">
    import * as pako from "pako";

    let recodeSocketOpen = false
    const recodeSocket = new WebSocket('ws://localhost:31371/codeutilities/item')
    recodeSocket.onopen = () => {
        recodeSocketOpen = true
    }

    let codeClientSocketOpen = false
    const codeClientSocket = new WebSocket('ws://localhost:31375');
    // Only mark connection as opened when we receive a message of "auth"
    codeClientSocket.onmessage = (event) => {
        if (event.data === "auth") {
            codeClientSocketOpen = true
        }
    }

    function encodeTemplate(template) {
        // GZIP & Base64 encode the template
        let data = pako.gzip(template)
        let data2 = String.fromCharCode.apply(null, [...new Uint16Array(data)]);
        return btoa(data2)
    }

    const picker = document.querySelector('input[type="file"]')

    picker.addEventListener("change", async () => {
        const FUNCTION_NAME = document.querySelector('#functionName').value.replace("\r", "")
        const VARIABLE_NAME = document.querySelector('#variableName').value.replace("\r", "")
        const USE_PARAMETER = document.querySelector('#useParameter').checked
        const VARIABLE_SCOPE = USE_PARAMETER ? "line" : document.querySelector('#variableScope').value

        if (picker.files.length !== 1) return;

        const file = picker.files[0]
        const text = await file.text()

        // We have the file, time to process!

        const lines = text.split('\n')


        // Our starting template with just the function block
        let template = {
            blocks: [
                {
                    id: "block",
                    block: "func",
                    args: {
                        items: [
                            {
                                item: {
                                    id: "bl_tag",
                                    data: {
                                        option: "False",
                                        tag: "Is Hidden",
                                        action: "dynamic",
                                        block: "func"
                                    }
                                },
                                slot: 26
                            }
                        ]
                    },
                    data: FUNCTION_NAME
                }
            ]
        }

        function getStringValue(str, slot) {
            return {
                item: {
                    id: "txt",
                    data: {
                        name: str.replace("\r", "")
                    }
                },
                slot: slot
            }
        }

        // Add the parameter into the function if needed
        if (USE_PARAMETER) {
            template.blocks[0].args.items.push({
                item: {
                    id: "pn_el",
                    data: {
                        name: VARIABLE_NAME,
                        type: "var",
                        plural: false,
                        optional: false
                    }
                },
                slot: 0
            })
        }

        let placedCreateList = false;
        let items = [
            {
                item: {
                    id: "var",
                    data: {
                        name: VARIABLE_NAME,
                        scope: VARIABLE_SCOPE
                    }
                },
                slot: 0
            }
        ]
        let slot = 1;
        for (let index in lines) {
            index = parseInt(index)

            // Place the action if we ran out of slots or if we're at the end of the lines
            if (slot === 27 || index === lines.length - 1) {
                template.blocks.push(
                    {
                        id: "block",
                        block: "set_var",
                        args: {
                            items: items
                        },
                        action: placedCreateList ? "AppendList" : "CreateList",
                    }
                )
                if (!placedCreateList) placedCreateList = true; // We only want to create the list once

                items = [
                    {
                        item: {
                            id: "var",
                            data: {
                                name: VARIABLE_NAME,
                                scope: VARIABLE_SCOPE
                            }
                        },
                        slot: 0
                    }
                ]
                slot = 1;
            }

            items.push(getStringValue(lines[index], slot))

            slot++
        }

        if (recodeSocketOpen) recodeSocket.send(JSON.stringify(
            {
                type: "template",
                data: JSON.stringify({
                    author: "Red DF Website",
                    name: "Text File to Template",
                    code: encodeTemplate(JSON.stringify(template)).toString()
                }),
                source: "Red DF Website"
            }
        ))

        if (codeClientSocketOpen)
            codeClientSocket.send(
                `give {Count:1b,Slot:0b,id:"minecraft:ender_chest",tag:{display: {Name: '{"text":"Text File To Template","color":"aqua","italic":false}'}, PublicBukkitValues:{"hypercube:codetemplatedata": '{"author":"Red DF Website","name":"Text File to Template","code":"${encodeTemplate(JSON.stringify(template))}"}'}}}`
            )

        document.querySelector('#resultText').innerText = "Template sent to recode and CodeClient!"

    })

</script>
</body>
</html>
